
import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const openAIApiKey = Deno.env.get('OPENAI_API_KEY');

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages, context } = await req.json();

    console.log('ChatGPT request received:', { messagesCount: messages?.length, context });

    if (!openAIApiKey) {
      throw new Error('OpenAI API key not configured');
    }

    // Create system message based on context
    let systemMessage = 'You are an AI assistant specialized in marketing analytics and campaign optimization.';
    
    if (context?.type === 'facebook_analysis') {
      systemMessage = `You are an expert Facebook Ads analyst. You help marketers optimize their campaigns by analyzing performance data, identifying trends, and providing actionable recommendations. Focus on metrics like CTR, CPM, CPC, ROAS, frequency, and audience optimization.`;
    } else if (context?.type === 'general_insights') {
      systemMessage = `You are a marketing analytics expert. You help analyze campaign performance, provide insights on conversion funnels, and suggest optimization strategies for digital marketing campaigns.`;
    }

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openAIApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemMessage },
          ...messages
        ],
        temperature: 0.7,
        max_tokens: 1000,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('OpenAI API error:', errorData);
      throw new Error(`OpenAI API error: ${errorData.error?.message || 'Unknown error'}`);
    }

    const data = await response.json();
    const aiResponse = data.choices[0].message.content;

    console.log('ChatGPT response generated successfully');

    return new Response(JSON.stringify({ response: aiResponse }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error in chat-gpt function:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});
